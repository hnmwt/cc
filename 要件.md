# 外観検査アプリケーション 要件定義書

## ドキュメント情報
- **プロジェクト名**: 外観検査システム
- **バージョン**: 1.0
- **作成日**: 2025-11-16
- **ステータス**: Draft

---

## 1. ビジネス要件

### 1.1 プロジェクトの目的
製造現場における製品の外観検査を自動化・効率化し、検査品質の向上と人的コストの削減を実現する。

### 1.2 解決すべき課題
- 手作業による検査の属人化と品質のばらつき
- 検査員の負担増加と人材不足
- 検査結果の記録・分析の非効率性
- リアルタイムな品質管理の困難さ

### 1.3 期待される効果
- 検査精度の向上と安定化（感度90%以上、特異度95%以上）
- 検査時間の短縮（1枚あたり100ms以下）
- 検査データの自動記録と統計分析
- 不良品の早期発見による品質向上

---

## 2. 機能要件

### FR-01: 画像入力機能

#### FR-01-01: カメラからのリアルタイム取得
- **優先度**: 中
- **説明**: カメラデバイスから画像をリアルタイムで取得する
- **詳細要件**:
  - USB2.0/3.0カメラに対応すること
  - 産業用カメラに対応すること
  - 解像度を640x480～1920x1080の範囲で設定可能とすること
  - フレームレートを15fps～60fpsの範囲で調整可能とすること
  - カメラパラメータ（露出、ゲイン、ホワイトバランス）を調整可能とすること

#### FR-01-02: ファイルからの読み込み
- **優先度**: 高
- **説明**: 既存の画像ファイルを読み込んで検査する
- **詳細要件**:
  - JPEG、PNG、BMP、TIFF形式に対応すること
  - 単一ファイルの読み込みに対応すること
  - 複数ファイルの一括読み込み（バッチ処理）に対応すること

### FR-02: 画像前処理機能

#### FR-02-01: 基本的な画像変換
- **優先度**: 高
- **説明**: 画像を検査に適した形式に変換する
- **詳細要件**:
  - グレースケール変換機能を提供すること
  - ノイズ除去機能（ガウシアンフィルタ、メディアンフィルタ）を提供すること
  - コントラスト調整機能を提供すること
  - 二値化処理（固定閾値、適応的閾値）を提供すること

#### FR-02-02: 高度な画像処理
- **優先度**: 高
- **説明**: 欠陥検出に必要な画像処理を実施する
- **詳細要件**:
  - エッジ検出（Canny、Sobel）機能を提供すること
  - モルフォロジー演算（膨張、収縮、オープニング、クロージング）を提供すること

#### FR-02-03: 画像処理パイプライン
- **優先度**: 高
- **説明**: 複数の画像処理を組み合わせて適用できる
- **詳細要件**:
  - 複数の画像処理を順次適用できること
  - 処理の順序を自由に設定できること
  - 各処理のON/OFFを切り替えられること
  - 処理の組み合わせをプリセットとして保存・読み込みできること
  - パイプライン処理の各段階の結果を確認できること

#### FR-02-04: AI画像高画質化
- **優先度**: 中
- **説明**: AIを用いて画像を高画質化する
- **詳細要件**:
  - 低解像度画像を高解像度化できること
  - ノイズ除去をAIで高精度に実施できること
  - ぼやけた画像をシャープ化できること
  - 高画質化モデルを選択できること（超解像、デノイジング等）
  - 処理前後の画像を比較表示できること

### FR-03: 欠陥検出機能

#### FR-03-01: テンプレートマッチング
- **優先度**: 高
- **説明**: 良品画像と比較して欠陥を検出する
- **詳細要件**:
  - 良品画像との差分を検出すること
  - マッチング精度の閾値を設定可能とすること
  - 複数の良品パターンを登録可能とすること

#### FR-03-02: 特徴量ベース検出
- **優先度**: 高
- **説明**: 画像の特徴量から欠陥を検出する
- **詳細要件**:
  - 輪郭検出機能を提供すること
  - 面積、周囲長、円形度を計算すること
  - 異常値を判定すること

#### FR-03-03: 統計的検出
- **優先度**: 中
- **説明**: 統計的手法により欠陥を検出する
- **詳細要件**:
  - ヒストグラム解析機能を提供すること
  - 標準偏差による異常検出を行うこと

#### FR-03-04: AI欠陥検出
- **優先度**: 高
- **説明**: 深層学習/機械学習を用いて欠陥を検出する
- **詳細要件**:
  - 深層学習モデル（CNN等）による欠陥検出機能を提供すること
  - 学習済みモデルを読み込んで使用できること
  - 複数のAIモデルを切り替えて使用できること
  - 検出結果の信頼度スコアを表示すること
  - ファインチューニング用の学習データを収集できること
  - モデルの再学習機能を提供すること（オプション）

### FR-04: 検査結果表示機能

#### FR-04-01: リアルタイム表示
- **優先度**: 高
- **説明**: 検査プロセスと結果をリアルタイムで表示する
- **詳細要件**:
  - 原画像を表示すること
  - 処理後画像を表示すること
  - 欠陥検出箇所をハイライト表示（矩形、円形マーカー）すること

#### FR-04-02: 判定結果表示
- **優先度**: 高
- **説明**: 検査の判定結果を明示する
- **詳細要件**:
  - OK/NG判定を表示すること
  - 欠陥の種類（傷、汚れ、変色、形状不良など）を分類表示すること
  - 検出された欠陥の数を表示すること
  - 信頼度スコアを表示すること
  - 処理時間を表示すること

### FR-05: データ管理機能

#### FR-05-01: 検査履歴の保存
- **優先度**: 中
- **説明**: 検査結果を永続化する
- **詳細要件**:
  - 検査日時を記録すること
  - 検査画像を保存すること
  - 判定結果を保存すること
  - 欠陥位置情報を保存すること

#### FR-05-02: データベース機能
- **優先度**: 中
- **説明**: 検査データを管理する
- **詳細要件**:
  - SQLiteによるローカルDBを使用すること
  - 検査データをCSV形式でエクスポートできること

#### FR-05-03: 統計情報
- **優先度**: 低
- **説明**: 検査結果の統計を提供する
- **詳細要件**:
  - 日次/週次/月次の検査統計を表示すること
  - 不良率の推移グラフを表示すること
  - 欠陥種類別の分布を表示すること

### FR-06: 設定機能

#### FR-06-01: 検査パラメータ設定
- **優先度**: 高
- **説明**: 検査の精度を調整する
- **詳細要件**:
  - 検出感度を調整可能とすること
  - 閾値を設定可能とすること
  - フィルタパラメータを設定可能とすること

#### FR-06-02: カメラ設定
- **優先度**: 中
- **説明**: カメラの動作を設定する
- **詳細要件**:
  - 露出、ゲイン、ホワイトバランスを調整可能とすること
  - カメラキャリブレーション機能を提供すること

#### FR-06-03: 良品登録
- **優先度**: 高
- **説明**: リファレンス画像を管理する
- **詳細要件**:
  - リファレンス画像を登録できること
  - 複数パターンを登録できること
  - 登録済み良品の一覧表示・削除ができること

### FR-07: レポート機能

#### FR-07-01: 検査レポート生成
- **優先度**: 低
- **説明**: 検査結果のレポートを生成する
- **詳細要件**:
  - PDF形式でレポートを自動生成すること
  - 不良品画像の一覧を出力すること
  - 統計グラフを出力すること

### FR-08: リアルタイム調整機能

#### FR-08-01: インタラクティブフィルタ調整画面
- **優先度**: 高
- **説明**: 画像処理パラメータをリアルタイムで調整できる画面を提供する
- **詳細要件**:
  - フィルタパラメータをスライダーで調整できること
  - パラメータ変更が即座に画像に反映されること（リアルタイムプレビュー）
  - 複数のフィルタを同時に調整できること
  - 調整前後の画像を並べて比較表示できること
  - 調整履歴を保持し、前の状態に戻せること（Undo/Redo機能）
  - 現在の設定値を数値で確認・直接入力できること
  - 調整結果をプリセットとして保存できること
  - 分割画面表示（元画像/処理後画像の同時表示）に対応すること

---

## 3. 非機能要件

### NFR-01: 性能要件

#### NFR-01-01: 処理速度
- **説明**: システムの応答性能
- **要件**:
  - 画像処理速度: 1枚あたり100ms以下
  - リアルタイム検査: 10fps以上で動作すること
  - UI操作の応答時間: 1秒以内

#### NFR-01-02: 検出精度
- **説明**: 欠陥検出の精度
- **要件**:
  - 感度（真陽性率）: 90%以上
  - 特異度（真陰性率）: 95%以上

### NFR-02: 可用性要件

#### NFR-02-01: システム稼働率
- **説明**: システムの安定稼働
- **要件**:
  - 連続稼働時間: 8時間以上
  - クラッシュ発生率: 週1回未満

#### NFR-02-02: エラーハンドリング
- **説明**: エラー時の適切な処理
- **要件**:
  - すべてのエラーを適切にキャッチし処理すること
  - エラー発生時に分かりやすいメッセージを表示すること
  - エラーログを記録すること

### NFR-03: 保守性要件

#### NFR-03-01: コード品質
- **説明**: 保守しやすいコード構造
- **要件**:
  - C++17以上の標準に準拠すること
  - モジュール化された設計とすること
  - コードドキュメントを整備すること

#### NFR-03-02: テスト
- **説明**: 品質保証のためのテスト
- **要件**:
  - ユニットテストを実装すること
  - テストカバレッジ: 70%以上

### NFR-04: セキュリティ要件

#### NFR-04-01: データ保護
- **説明**: データの安全性確保
- **要件**:
  - 入力値の検証を徹底すること
  - メモリリークを防止すること
  - バッファオーバーフローを防止すること

### NFR-05: 移植性要件

#### NFR-05-01: マルチプラットフォーム対応
- **説明**: 複数のOSで動作する
- **要件**:
  - Windows 10/11で動作すること
  - Linux (Ubuntu 20.04以上)で動作すること
  - macOSで動作すること

### NFR-06: 拡張性要件

#### NFR-06-01: プラグイン可能なアーキテクチャ
- **説明**: 画像処理アルゴリズムの追加実装が容易である
- **要件**:
  - 画像処理アルゴリズムが独立したモジュールとして実装されていること
  - 新しい画像処理アルゴリズムを既存コードの変更なしに追加できること
  - 共通インターフェース（基底クラス/抽象クラス）を使用した設計であること
  - アルゴリズムの動的な読み込み・登録が可能であること
  - プラグイン形式（DLL/SO）での追加実装に対応すること
  - 各アルゴリズムのメタデータ（名前、パラメータ定義等）を定義できること
  - アルゴリズムの追加時にビルド・再コンパイルが不要であること（オプション）

#### NFR-06-02: 設定の外部化
- **説明**: アルゴリズムの設定を外部ファイルで管理できる
- **要件**:
  - アルゴリズムの設定をJSON/YAML等の設定ファイルで管理できること
  - 設定ファイルの読み込みによりアルゴリズムを追加・変更できること
  - パラメータのバリデーション機能を提供すること

#### NFR-06-03: ドキュメント化
- **説明**: アルゴリズム追加のためのドキュメントが整備されている
- **要件**:
  - アルゴリズム追加の手順書が提供されていること
  - サンプル実装が提供されていること
  - APIドキュメントが整備されていること

---

## 4. システム要件

### 4.1 ハードウェア要件

#### 最小要件
- **CPU**: Intel Core i3以上
- **メモリ**: 4GB以上
- **ストレージ**: 500MB以上の空き容量
- **カメラ**: USB2.0対応カメラ

#### 推奨要件
- **CPU**: Intel Core i5以上
- **メモリ**: 8GB以上
- **ストレージ**: 2GB以上の空き容量
- **カメラ**: USB3.0対応カメラまたは産業用カメラ

### 4.2 ソフトウェア要件

#### 開発環境
- **言語**: C++17以上
- **画像処理ライブラリ**: OpenCV 4.x
- **GUI**: Qt 5/6 または OpenCV HighGUI
- **データベース**: SQLite3
- **ビルドシステム**: CMake 3.15以上
- **コンパイラ**: GCC 7+、Clang 6+、MSVC 2019+

#### 実行環境
- **OS**: Windows 10/11、Linux (Ubuntu 20.04以上)、macOS 10.15以上
- **ランタイム**: OpenCV 4.x、Qt 5/6 (GUIを使用する場合)

---

## 5. 制約事項

### 5.1 技術的制約
- OpenCV 4.xに依存するため、対応する機能セットに限定される
- カメラはOpenCVがサポートするデバイスに限定される
- リアルタイム性能はハードウェアスペックに依存する

### 5.2 プロジェクト制約
- 初期開発フェーズでは単一カメラのみ対応
- AI/深層学習機能は将来拡張として位置づける
- ネットワーク機能は将来拡張として位置づける

### 5.3 運用制約
- ローカル環境での使用を前提とする
- マルチユーザー対応は不要
- 同時実行は1インスタンスのみ

---

## 6. インターフェース要件

### 6.1 ユーザーインターフェース
- 直感的で分かりやすいGUIを提供すること
- メイン画面に原画像と処理結果を並べて表示すること
- 検査結果を視覚的に分かりやすく表示すること
- パラメータ調整をリアルタイムで反映できること

### 6.2 ハードウェアインターフェース
- USB2.0/3.0カメラに対応すること
- 産業用カメラ（GigE、USB3 Vision等）に対応すること

### 6.3 データインターフェース
- CSV形式でのデータエクスポートに対応すること
- 標準的な画像形式（JPEG、PNG、BMP、TIFF）に対応すること

---

## 7. 検証・受け入れ基準

### 7.1 機能テスト
- すべての機能要件が実装され、正常に動作すること
- 各種画像形式の読み込みが正常に行えること
- 欠陥検出が仕様通りの精度で動作すること

### 7.2 性能テスト
- 処理速度が要件（100ms/枚）を満たすこと
- リアルタイム検査が要件（10fps以上）を満たすこと
- 連続稼働テスト（8時間）をパスすること

### 7.3 品質テスト
- ユニットテストカバレッジが70%以上であること
- メモリリークが検出されないこと
- クラッシュせず安定動作すること

---

## 8. 実装優先度

### Phase 1: 基本機能（優先度：高）- MVP
- 画像ファイルの読み込み
- 基本的な画像処理（グレースケール、二値化）
- 簡易的な欠陥検出（差分検出）
- 結果の画面表示

### Phase 2: 検出精度向上（優先度：高）
- 各種フィルタの実装
- 複数の検出アルゴリズム実装
- パラメータ調整機能

### Phase 3: データ管理（優先度：中）
- SQLiteデータベース統合
- 検査履歴の保存・閲覧
- CSVエクスポート

### Phase 4: カメラ対応（優先度：中）
- カメラデバイスの接続
- リアルタイム画像取得
- 連続検査モード

### Phase 5: UI改善（優先度：低）
- Qtベースの本格的なGUI
- 設定画面の実装
- グラフ表示機能

### Phase 6: レポート機能（優先度：低）
- PDF生成機能
- 統計分析機能
- データ可視化

---

## 9. リスクと課題

### 9.1 技術的リスク
- **リスク**: カメラドライバの互換性問題
- **対策**: 主要なカメラメーカーのデバイスで事前検証を実施

- **リスク**: 処理速度が要件を満たせない
- **対策**: 早期にプロトタイプを作成し性能検証を実施

- **リスク**: 検出精度が目標値に達しない
- **対策**: 複数のアルゴリズムを実装し最適な手法を選定

### 9.2 プロジェクトリスク
- **リスク**: OpenCVのバージョン変更による影響
- **対策**: 特定バージョンに固定し、アップデート計画を慎重に策定

---

## 10. 将来拡張

以下の機能は将来的な拡張として検討：
- AI（深層学習）による欠陥検出
- クラウド連携機能
- 複数カメラ同時制御
- 自動レポート送信機能
- 多言語対応
- Web UI対応
- モバイルアプリ連携

---

## 11. 参考資料

- プロジェクト仕様書: `project.md`
- OpenCV Documentation: https://docs.opencv.org/
- Qt Documentation: https://doc.qt.io/
- 産業用画像処理のベストプラクティス

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|----------|------|---------|--------|
| 1.0 | 2025-11-16 | 初版作成 | - |
