# 外観検査アプリケーション 開発メモ

## プロジェクト概要

**目的**: 製造現場における製品の外観検査を自動化・効率化するシステム

**主要技術**:
- C++20
- OpenCV 4.x (画像処理)
- Qt 6.x (GUI)
- ONNX Runtime (AI推論)
- SQLite3 (データ管理)

---

## 重要ドキュメント

| ドキュメント | 内容 |
|------------|------|
| `project.md` | プロジェクト仕様書（全体像） |
| `要件.md` | 詳細な要件定義（機能要件・非機能要件） |
| `実装計画.md` | 実装の詳細計画（10フェーズ） |
| `React移行計画.md` | React移行を考慮した設計 |
| `通信フォーマット設計.md` | API・通信プロトコルの詳細仕様 |
| `CSV出力仕様.md` | CSV自動出力・画像保存の仕様 |
| `claude.md` | AI指示書（project.mdを参照する） |
| `開発メモ.md` | 本ファイル（重要事項のメモ） |

---

## 重要な要件まとめ

### 機能要件の追加項目

1. **画像処理パイプライン** (FR-02-03)
   - 複数の画像処理を組み合わせて適用
   - 処理の順序を自由に変更可能
   - プリセット保存・読み込み

2. **AI画像高画質化** (FR-02-04)
   - 超解像、デノイジング、シャープ化
   - モデルの選択機能

3. **AI欠陥検出** (FR-03-04)
   - 深層学習モデル（CNN等）による検出
   - 複数モデルの切り替え
   - 学習データ収集機能

4. **リアルタイム調整機能** (FR-08-01)
   - フィルタパラメータのリアルタイム調整
   - Undo/Redo機能
   - 分割画面表示

### 非機能要件の追加項目

5. **拡張性要件** (NFR-06)
   - プラグイン可能なアーキテクチャ
   - 画像処理アルゴリズムの追加実装が容易
   - 設定の外部化（JSON/YAML）

---

## アーキテクチャ設計

### レイヤー構造（React移行対応版）

```
Frontend Layer (Qt/OpenCV → 将来React)
    ↓
API Layer (JSON入出力) ★重要: フロントエンド非依存
    ↓
Application Layer (Controllers)
    ↓
Processing Layer (Filters, Detectors)
    ↓
Core Layer (I/O, Plugin Manager, Config)
    ↓
Data Layer (SQLite, Files)
```

**React移行の考慮点:**
- API層を導入してバックエンドとフロントエンドを分離
- すべてのデータ交換はJSON形式
- ビジネスロジックはUI非依存に実装
- 詳細は `React移行計画.md` を参照

**通信フォーマット:**
- **基本**: JSON over HTTP REST
- **リアルタイム**: WebSocket（カメラフィード、進捗通知）
- **画像転送**: ファイルパス、Base64、マルチパート
- 詳細は `通信フォーマット設計.md` を参照

### 設計原則（SOLID）

1. **Single Responsibility**: 各クラスは1つの責任のみ
2. **Open/Closed**: 拡張に開いて、修正に閉じている
3. **Liskov Substitution**: 派生クラスは基底クラスと置き換え可能
4. **Interface Segregation**: 必要なインターフェースのみ実装
5. **Dependency Inversion**: 抽象に依存、具象に依存しない

### 主要デザインパターン

| パターン | 用途 | 実装箇所 |
|---------|------|---------|
| Strategy | アルゴリズムの交換 | FilterBase, DetectorBase |
| Factory | オブジェクト生成 | PluginManager |
| Chain of Responsibility | パイプライン処理 | Pipeline |
| Observer | イベント通知 | InspectionController |
| Singleton | グローバルインスタンス | PluginManager, ConfigManager |
| Template Method | アルゴリズムの骨組み | DetectorBase |
| Facade | 複雑さの隠蔽 | InspectionFacade |
| Builder | 複雑なオブジェクト構築 | PipelineBuilder |

---

## クラス設計の要点

### 基底クラス設計

```cpp
// フィルタ基底クラス
class FilterBase {
public:
    virtual cv::Mat process(const cv::Mat& input) = 0;
    virtual std::string getName() const = 0;
    virtual void setParameter(const std::string& name, const Variant& value) = 0;
    bool isEnabled() const;
    void setEnabled(bool enabled);
};

// 検出器基底クラス
class DetectorBase {
public:
    virtual std::vector<Defect> detect(const cv::Mat& image) = 0;
    virtual std::string getName() const = 0;
    double getSensitivity() const;
    void setSensitivity(double value);
};
```

### パイプライン設計

```cpp
class Pipeline {
public:
    void addFilter(std::unique_ptr<FilterBase> filter);
    cv::Mat process(const cv::Mat& input);
    std::vector<cv::Mat> processWithIntermediates(const cv::Mat& input);
private:
    std::vector<std::unique_ptr<FilterBase>> filters_;
};
```

### プラグインマネージャー設計

```cpp
class PluginManager {
public:
    static PluginManager& getInstance();

    template<typename T>
    void registerPlugin(const std::string& name,
                       std::function<std::unique_ptr<T>()> creator);

    template<typename T>
    std::unique_ptr<T> createPlugin(const std::string& name);
};
```

---

## AI機能の実装方法

### AI起動フロー

```
1. ONNX Runtime環境の初期化
   ↓
2. モデルファイル(.onnx)の読み込み
   ↓
3. セッションの作成
   ↓
4. 推論実行時:
   - 入力画像の前処理
   - テンソルに変換
   - session_->Run()で推論
   - 出力テンソルを取得
   - 後処理（OpenCV Matに変換）
```

### AIEnhancer実装の要点

```cpp
class AIEnhancer : public FilterBase {
public:
    void loadModel(const std::string& modelPath);
    cv::Mat process(const cv::Mat& input) override;

private:
    std::unique_ptr<Ort::Env> env_;
    std::unique_ptr<Ort::Session> session_;

    cv::Mat preprocess(const cv::Mat& input);   // 正規化等
    cv::Mat postprocess(const std::vector<float>& output, cv::Size size);
};
```

### AIDetector実装の要点

```cpp
class AIDetector : public DetectorBase {
public:
    void loadModel(const std::string& modelPath);
    std::vector<Defect> detect(const cv::Mat& image) override;

private:
    std::unique_ptr<Ort::Session> session_;
    std::vector<Defect> postprocessDetections(...);  // NMS等
};
```

### モデルファイル配置

```
data/
└── models/
    ├── enhancer/
    │   ├── esrgan.onnx       # 超解像
    │   └── denoise.onnx      # ノイズ除去
    └── detector/
        ├── yolov8.onnx       # 物体検出
        └── unet.onnx         # セグメンテーション
```

---

## ディレクトリ構造

```
inspection_app/
├── CMakeLists.txt
├── README.md
├── project.md
├── 要件.md
├── 実装計画.md
├── 開発メモ.md
│
├── include/              # ヘッダーファイル
│   ├── core/            # ImageIO, PluginManager, ConfigManager
│   ├── processing/      # FilterBase, Pipeline, 各種フィルタ
│   ├── detection/       # DetectorBase, 各種検出器
│   ├── app/             # Controllers
│   ├── ui/              # GUI
│   └── utils/           # Logger, Timer等
│
├── src/                 # 実装ファイル
│   ├── core/
│   ├── processing/
│   ├── detection/
│   ├── app/
│   ├── ui/
│   ├── utils/
│   └── main.cpp
│
├── tests/               # テストコード
│   ├── unit/
│   └── integration/
│
├── config/              # 設定ファイル
│   ├── default_config.json
│   ├── filters.json
│   └── presets/
│
├── data/                # データ
│   ├── reference/       # 良品画像
│   ├── test_images/
│   └── models/          # AIモデル
│
└── docs/                # ドキュメント
    ├── api/
    └── user_guide.md
```

---

## 実装フェーズ（優先順位順）

### Phase 1: 基礎インフラ構築（2-3週間）★最優先
- [ ] CMakeLists.txt作成
- [ ] ディレクトリ構造構築
- [ ] ImageIO実装
- [ ] ConfigManager実装
- [ ] FilterBase, Pipeline実装
- [ ] 基本フィルタ（Grayscale, Gaussian, Threshold）
- [ ] 簡易UI（OpenCV HighGUI）

**マイルストーン**: 画像読み込み→フィルタ適用→表示

### Phase 2: 検出機能実装（3-4週間）
- [ ] DetectorBase実装
- [ ] TemplateMatcher実装
- [ ] FeatureDetector実装
- [ ] StatisticalDetector実装
- [ ] InspectionController実装
- [ ] 追加フィルタ（Median, Edge, Morphology）

**マイルストーン**: 欠陥検出精度90%達成

### Phase 3: プラグインシステム実装（2-3週間）
- [ ] PluginManager実装
- [ ] パラメータシステム
- [ ] リアルタイム調整UI
- [ ] プリセット機能
- [ ] プラグイン開発ガイド作成

**マイルストーン**: 新規フィルタ追加が容易

### Phase 4: データ管理（2週間）
- [ ] SQLiteデータベース設計
- [ ] DataManager実装
- [ ] 検査履歴保存・閲覧
- [ ] CSV エクスポート

### Phase 5: カメラ対応（2週間）
- [ ] CameraController実装
- [ ] リアルタイム検査
- [ ] カメラパラメータ調整

### Phase 6: AI機能実装（3-4週間）
- [ ] ONNX Runtime統合
- [ ] AIEnhancer実装
- [ ] AIDetector実装
- [ ] モデル管理UI

### Phase 7: UI改善（Qt版）（2-3週間）
- [ ] Qt環境構築
- [ ] MainWindow実装
- [ ] FilterPanel実装
- [ ] ResultDisplay実装
- [ ] グラフ表示

### Phase 8-10: レポート、テスト、リリース（4-5週間）

---

## 技術スタック詳細

### 必須ライブラリ

| ライブラリ | バージョン | 用途 |
|-----------|-----------|------|
| OpenCV | 4.x | 画像処理 |
| Qt | 6.x | GUI |
| nlohmann/json | 3.x | JSON解析 |
| SQLiteCpp | 3.x | データベース |
| ONNX Runtime | 1.x | AI推論 |
| Google Test | 1.x | テスト |
| spdlog | 1.x | ロギング |

### ビルド環境

- **C++標準**: C++20
- **CMake**: 3.15以上
- **コンパイラ**:
  - macOS: Apple Clang 17.0.0
  - Linux: GCC 7+, Clang 6+
  - Windows: MSVC 2019+

### 現在の設定

```json
// .vscode/tasks.json
{
  "args": [
    "-std=c++20",        // C++20使用
    "-fcolor-diagnostics",
    "-fansi-escape-codes",
    "-g",
    "${file}",
    "-o",
    "${fileDirname}/${fileBasenameNoExtension}"
  ]
}
```

---

## コーディング規約

### 命名規則

- クラス名: `PascalCase` (例: `ImageProcessor`)
- 関数名: `camelCase` (例: `processImage()`)
- 変数名: `snake_case` (例: `image_data`)
- 定数名: `UPPER_SNAKE_CASE` (例: `MAX_IMAGE_SIZE`)
- メンバ変数: 末尾に `_` (例: `data_`)

### ファイル規則

- ヘッダー: `.hpp`
- ソース: `.cpp`
- ヘッダーガード: `#pragma once`

### エラーハンドリング

```cpp
// 例外を使用
try {
    auto result = process();
} catch (const std::exception& e) {
    LOG_ERROR("Error: {}", e.what());
}

// 戻り値で判定が必要な場合
std::optional<cv::Mat> loadImageSafe(const std::string& path);
```

### メモリ管理

- スマートポインタ優先
  - `std::unique_ptr`: 単独所有
  - `std::shared_ptr`: 共有所有
- `new`/`delete`の直接使用を避ける
- RAII パターン活用

---

## 性能要件

- **処理速度**: 1枚あたり100ms以下
- **リアルタイム検査**: 10fps以上
- **検出精度**: 感度90%以上、特異度95%以上
- **テストカバレッジ**: 70%以上

---

## 次のステップ（即座に開始）

### 1. 環境構築
```bash
# ディレクトリ作成
mkdir -p inspection_app/{include,src,tests,config,data,docs}
mkdir -p inspection_app/include/{core,processing,detection,app,ui,utils}
mkdir -p inspection_app/src/{core,processing,detection,app,ui,utils}

# OpenCVインストール（macOS）
brew install opencv

# ONNX Runtimeインストール
brew install onnxruntime
```

### 2. CMakeLists.txt作成

```cmake
cmake_minimum_required(VERSION 3.15)
project(InspectionApp VERSION 1.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

find_package(OpenCV 4 REQUIRED)
find_package(Qt6 COMPONENTS Widgets REQUIRED)

add_executable(inspection_app
    src/main.cpp
    src/core/image_io.cpp
    # 他のソースファイルを追加
)

target_link_libraries(inspection_app
    PRIVATE
    ${OpenCV_LIBS}
    Qt6::Widgets
)
```

### 3. 初期実装（Phase 1）

**優先順位:**
1. ImageIO クラス
2. FilterBase 抽象クラス
3. GrayscaleFilter 実装
4. Pipeline クラス
5. **InspectionAPI クラス（JSON入出力）** ★React移行対応
6. 簡易的なmain.cpp（画像読み込み→処理→表示）

---

## 重要な注意事項

### プラグインアーキテクチャ
- すべてのフィルタと検出器は抽象クラスを継承
- PluginManagerで動的に登録・取得
- 設定ファイルからの読み込みに対応

### 拡張性
- 新しいアルゴリズムの追加が既存コード変更なしで可能
- インターフェースを統一し疎結合を維持
- ドキュメント（プラグイン開発ガイド）を整備

### テスタビリティ
- 依存性注入を活用
- インターフェースに依存することでモック化が容易
- ユニットテストを Phase 1 から書く

---

## リスク管理

| リスク | 対策 |
|--------|------|
| OpenCVバージョン互換性 | 特定バージョンに固定 |
| AIモデルのパフォーマンス不足 | 軽量モデル選定、最適化 |
| カメラドライバ互換性 | 主要デバイスで事前検証 |
| 処理速度が要件未達 | 早期プロトタイプ、並列処理導入 |

---

## 参考資料

- [OpenCV Documentation](https://docs.opencv.org/)
- [Qt Documentation](https://doc.qt.io/)
- [ONNX Runtime](https://onnxruntime.ai/)
- [Google C++ Style Guide](https://google.github.io/styleguide/cppguide.html)
- [CMake Tutorial](https://cmake.org/cmake/help/latest/guide/tutorial/index.html)

---

## 開発進捗チェックリスト

### 環境構築
- [ ] ディレクトリ構造作成
- [ ] CMakeLists.txt作成
- [ ] OpenCV インストール・動作確認
- [ ] Git リポジトリ初期化

### Phase 1 (基礎インフラ)
- [ ] ImageIO 実装
- [ ] ConfigManager 実装
- [ ] FilterBase 定義
- [ ] Pipeline 実装
- [ ] GrayscaleFilter 実装
- [ ] GaussianFilter 実装
- [ ] ThresholdFilter 実装
- [ ] 簡易UI作成
- [ ] 動作確認（画像読み込み→処理→表示）

### Phase 2以降
- 実装計画.md を参照

---

## メモ欄

### 2025-11-16
- プロジェクト初期設定完了
- C++20に設定変更
- 要件定義書、実装計画書作成完了
- 設計パターンとアーキテクチャ確定
- **React移行を考慮した設計を追加**
  - API層（JSON入出力）の導入
  - Backend/Frontend分離
  - 将来のHTTP Server対応を考慮
  - Electron + React、HTTP Server + React、WebAssemblyの3つのオプション検討
- **外部機器連携要件を追加** ★重要
  - 外部機器（PLC、センサー）からの撮影トリガー受信
  - Backend起点の自動検査フロー
  - WebSocketによるプッシュ通知（Backend → React）
  - 双方向通信の実装（REST + WebSocket）
  - 通信フォーマット設計書を作成
- **CSV自動出力・画像保存機能を追加** ★重要
  - 検査完了時に自動的にCSV出力
  - 日付ごとにファイル分割（inspection_2025-11-16.csv）
  - UTF-8 BOM付き（Excel対応）
  - 元画像・処理後画像・マーキング画像を自動保存
  - 欠陥を色分けして可視化
  - CSV出力仕様書を作成

### 重要な変更点
**システムフロー:**
```
外部機器 → Backend (TCP/UDP): 撮影トリガー
  ↓
Backend: カメラ撮影・検査実行
  ↓
Backend → React (WebSocket): 結果プッシュ通知
  ↓
React: リアルタイム表示・アラート
```

### TODO
- Phase 1 開始
- CMakeLists.txt 作成
- **InspectionAPI クラス実装（JSON入出力）** ← React移行対応
- **ExternalTriggerHandler クラス実装（TCP Socket）** ← 外部機器対応
- **WebSocket サーバー実装** ← プッシュ通知対応
- **CSVWriter クラス実装** ← CSV自動出力
- **ImageSaver クラス実装** ← 画像自動保存
- 基本クラス実装開始

---

**最終更新**: 2025-11-16
